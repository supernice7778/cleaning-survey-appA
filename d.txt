<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“æƒå·¥ä½œåˆ†é…æ¸¬é©—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase objects globally (æ–°å¢ Timestamp)
        window.firebase = { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, deleteDoc, setLogLevel,
            Timestamp
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f3f9; }
        .macaron-pink { background-color: #ffe0e6; }
        .macaron-blue { background-color: #e0f2ff; }
        .macaron-green { background-color: #e0fff2; }
        .card-shadow { box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .quiz-transition { transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; }
        .trait-S { background-color: #e0fff2; border-color: #38a169; }
        .trait-Z { background-color: #fffde0; border-color: #d69e2e; }
        .trait-H { background-color: #ffe0e6; border-color: #d53f8c; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-3xl mx-auto macaron-blue rounded-3xl p-6 md:p-10 card-shadow min-h-[80vh] flex flex-col justify-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-6 text-center tracking-wider border-b-4 border-pink-500 pb-4">
            æ‰“æƒå·¥ä½œåˆ†é… <span class="text-pink-600">æ¸¬é©—</span>
        </h1>
        
        <!-- æ‡‰ç”¨ç¨‹å¼ä¸»é«”å°‡åœ¨é€™è£¡åˆ‡æ› -->
        <div id="content-container">
            <!-- é è¨­é¡¯ç¤ºèµ·å§‹é é¢ -->
            <div id="start-screen" class="space-y-6">
                <p class="text-lg text-gray-600 text-center">è«‹è¼¸å…¥æ‚¨çš„å§“åä»¥é–‹å§‹æ¸¬é©—ã€‚æ¸¬é©—çµæœå°‡ç”¨æ–¼æœ€çµ‚çš„åˆ†çµ„åˆ†é…ã€‚</p>
                
                <input type="text" id="name-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" 
                       class="w-full p-3 border-2 border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-lg">
                
                <div class="flex items-start">
                    <input type="checkbox" id="consent-checkbox" class="mt-1 h-5 w-5 text-pink-600 border-gray-300 rounded">
                    <label for="consent-checkbox" class="ml-3 text-sm text-gray-700">
                        æˆ‘åŒæ„æ¸¬é©—çµæœå°‡è¢«ç”¨æ–¼åœ˜éšŠåˆ†çµ„ï¼Œä¸¦åŒæ„æˆ‘çš„å§“åå’Œçµæœè¢«ä¸»æŒäººæŸ¥çœ‹ã€‚
                    </label>
                </div>
                
                <button onclick="startQuiz()" 
                        class="w-full p-4 text-xl font-extrabold text-white bg-pink-600 rounded-xl shadow-xl hover:bg-pink-700 transition duration-150 disabled:opacity-50" disabled id="startButton">
                    é–‹å§‹æ¸¬é©— (30 åˆ†é˜)
                </button>

                <!-- éŒ¯èª¤/æç¤ºè¨Šæ¯ -->
                <p id="start-message" class="text-red-500 text-center font-bold"></p>

                <!-- é‡ç½®è³‡æ–™å€å¡Š (ä¸»æŒäºº/æ¸¬è©¦è€…å°ˆç”¨) -->
                <div class="border-t pt-4 mt-6 border-gray-300">
                    <h2 class="text-xl font-bold text-gray-800 mb-3 text-center">æ¸¬è©¦èˆ‡é‡ç½®å·¥å…·</h2>
                    
                    <button onclick="confirmClearMyData()" id="clearMyDataButton" disabled
                            class="w-full p-3 text-base font-bold text-white bg-yellow-600 rounded-xl shadow-md hover:bg-yellow-700 transition duration-150 mb-3 disabled:opacity-50">
                        ğŸ—‘ï¸ æ¸…é™¤æˆ‘ç›®å‰çš„æäº¤ç´€éŒ„ (é‡æ–°æ¸¬è©¦)
                    </button>

                    <p class="text-xs text-gray-500 text-center mt-2">ä½¿ç”¨ã€Œæ¸…é™¤æˆ‘ç›®å‰çš„æäº¤ç´€éŒ„ã€åŠŸèƒ½å‰ï¼Œè«‹å…ˆè¼¸å…¥æ‚¨çš„å§“åã€‚</p>

                    <!-- Custom Modal for Confirmation -->
                    <div id="custom-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
                        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                            <h3 class="text-xl font-bold mb-4 text-red-600">è­¦å‘Š</h3>
                            <p id="confirm-message" class="text-gray-700 mb-6"></p>
                            <div class="flex justify-end space-x-4">
                                <button onclick="handleConfirmation(false)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">å–æ¶ˆ</button>
                                <button onclick="handleConfirmation(true)" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">ç¢ºå®š</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¸¬é©—é€²è¡Œä¸­ -->
            <div id="quiz-screen" class="hidden quiz-transition">
                <div class="flex justify-between items-center mb-6 border-b pb-3">
                    <span id="question-counter" class="text-xl font-bold text-pink-600">å•é¡Œ 1 / 5</span>
                    <span id="timer" class="text-2xl font-extrabold text-gray-800 bg-pink-200 px-4 py-1 rounded-full shadow-inner">30:00</span>
                </div>
                
                <div id="quiz-area" class="macaron-pink p-5 rounded-xl shadow-md space-y-4">
                    <h2 id="question-text" class="text-xl font-semibold text-gray-800"></h2>
                    <div id="options-container" class="space-y-3">
                        <!-- Options will be injected here -->
                    </div>
                </div>

                <div class="flex justify-between mt-6">
                    <button onclick="prevQuestion()" id="prevButton" disabled
                            class="px-6 py-3 text-lg font-semibold bg-gray-300 rounded-xl hover:bg-gray-400 transition disabled:opacity-50">
                        ä¸Šä¸€æ­¥
                    </button>
                    <button onclick="nextQuestion()" id="nextButton" disabled
                            class="px-6 py-3 text-lg font-semibold text-white bg-pink-600 rounded-xl shadow-md hover:bg-pink-700 transition disabled:opacity-50">
                        ä¸‹ä¸€æ­¥
                    </button>
                    <button onclick="submitQuiz()" id="submitButton" 
                            class="px-6 py-3 text-lg font-semibold text-white bg-green-600 rounded-xl shadow-md hover:bg-green-700 transition hidden disabled:opacity-50">
                        æäº¤æ¸¬é©—
                    </button>
                </div>
            </div>

            <!-- çµæœé é¢ -->
            <div id="result-screen" class="hidden quiz-transition text-center">
                <h2 class="text-2xl font-bold text-pink-600 mb-4">æ¸¬é©—çµæœèˆ‡åˆ†çµ„ç‹€æ…‹</h2>
                
                <div class="macaron-pink p-6 rounded-xl shadow-md space-y-4">
                    <p id="result-status" class="text-xl font-semibold text-gray-800">âœ… æäº¤æˆåŠŸï¼æ­£åœ¨ç­‰å¾…æœ€çµ‚åˆ†çµ„çµæœ...</p>
                    <div id="my-trait-display" class="text-left p-3 rounded-lg border-l-4 border-pink-500 bg-pink-50">
                        <p class="font-bold text-gray-700">æ‚¨çš„å‚¾å‘åˆ†æ (S: æƒæ‹–, Z: æ•´ç†, H: æ´»å‹•)</p>
                        <p id="trait-scores" class="text-sm text-gray-600"></p>
                    </div>

                    <!-- æœ€çµ‚åˆ†çµ„çµæœé¡¯ç¤ºå€ -->
                    <div id="final-assignment-display" class="hidden text-left macaron-green p-4 rounded-xl shadow-inner border-2 border-green-400">
                        <h3 class="text-2xl font-extrabold text-green-700 mb-2">ğŸ‰ æ‚¨çš„æœ€çµ‚åˆ†é…çµæœ</h3>
                        <div id="my-task-detail" class="text-lg font-bold text-gray-800"></div>
                        <p id="team-members" class="text-base text-gray-600 mt-2"></p>
                    </div>

                    <button onclick="checkAssignment()" id="checkAssignmentButton"
                            class="mt-4 px-6 py-3 text-lg font-semibold text-white bg-blue-600 rounded-xl shadow-md hover:bg-blue-700 transition disabled:opacity-50">
                        ğŸ”„ æª¢æŸ¥åˆ†çµ„çµæœ
                    </button>
                </div>
            </div>
            
            <!-- éŒ¯èª¤/æç¤ºæ¨¡æ…‹æ¡† (å–ä»£ alert) -->
            <div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-transform duration-300">
                    <h3 id="alert-title" class="text-xl font-bold mb-4 text-red-600">éŒ¯èª¤</h3>
                    <p id="alert-message" class="text-gray-700 mb-6"></p>
                    <button onclick="closeCustomAlert()" class="w-full bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transition">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>

<script>
    let db, auth, userId;
    let userName = '';
    let currentQuizState = {
        questions: [], // éš¨æ©Ÿæ’åºå¾Œçš„é¡Œç›®
        currentQuestionIndex: 0,
        answers: {}, // å„²å­˜ç­”æ¡ˆ {0: 'A', 1: 'B', ...}
        startTime: null,
        timerInterval: null,
        timeLimitSeconds: 1800, // 30 minutes
        isSubmitted: false
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // å®šç¾©è³‡æ–™åº«è·¯å¾‘ (èˆ‡ host_view.html ä¿æŒä¸€è‡´)
    const SUBMISSION_COLLECTION_PATH = 'artifacts/' + appId + '/public/data/submissions';
    const FINAL_ASSIGNMENT_DOC_PATH = 'artifacts/' + appId + '/public/data/FINAL_ASSIGNMENT_STATUS/team_list';

    let firebaseConfig = {};
    try { firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'); } catch (e) {}

    // åŸå§‹é¡Œç›®å®šç¾© (èˆ‡ PDF å…§å®¹å°æ‡‰ï¼Œä½†æ–°å¢äº†è¨ˆç®—æ¬Šé‡)
    const originalQuestions = [
        {
            text: "æ‚¨èªç‚ºæœ€èƒ½å¸¶ä¾†ç™‚ç™’æ„Ÿçš„å®¶äº‹æ˜¯?",
            options: [
                { text: "A. çœ‹åˆ°åœ°æ¿å¾é«’æ±¡è®Šä¹¾æ·¨", trait: 'S' }, // æƒæ‹–
                { text: "B. æŠŠé›œäº‚çš„æ«ƒå­æ•´ç†å¾—äº•äº•æœ‰æ¢", trait: 'Z' }, // æ•´ç†
                { text: "C. æº–å‚™ä¸€é “è±ç››ç¾å‘³çš„é¤é»", trait: 'H' }  // æ´»å‹•
            ]
        },
        {
            text: "æ‚¨çš„ç†æƒ³å·¥ä½œç‹€æ…‹æ˜¯?",
            options: [
                { text: "A. å¤§é¢ç©ã€æŒçºŒæ€§ã€é‡è¤‡çš„æ“ä½œ", trait: 'S' },
                { text: "B. ç´°ç¯€å¤šã€éœ€è¦è€å¿ƒã€æœ‰æˆå°±æ„Ÿçš„ä»»å‹™", trait: 'Z' },
                { text: "C. å„ªå…ˆè™•ç†æœ€ç·Šæ€¥ã€æ³¨é‡æ™‚æ•ˆæ€§ã€èƒ½èˆ‡äººäº’å‹•çš„ä»»å‹™", trait: 'H' }
            ]
        },
        {
            text: "æ‚¨æœ€ä¸å–œæ­¡æ‰“æƒæ™‚é‡åˆ°å“ªç¨®ç‹€æ³?",
            options: [
                { text: "A. åˆ°è™•éƒ½æ˜¯ç°å¡µå’Œæ¯›é«®", trait: 'S' },
                { text: "B. å†°ç®±å…§æœ‰éæœŸæˆ–ç™¼éœ‰çš„é£Ÿç‰©", trait: 'Z' },
                { text: "C. æ´»å‹•è‡¨æ™‚å‡ºåŒ…ï¼Œéœ€è¦ç·Šæ€¥è™•ç†", trait: 'H' }
            ]
        },
        {
            text: "æ‚¨çš„å¼·è¿«ç—‡æœ€å®¹æ˜“åœ¨ä½•è™•ç™¼ä½œ?",
            options: [
                { text: "A. åœ°é¢æœ‰ä¸€å¡Šæ±¡æ¼¬æ²’æ‹–ä¹¾æ·¨", trait: 'S' },
                { text: "B. å„²è—å®¤çš„ç‰©å“æ“ºæ”¾ä¸æ•´é½Š", trait: 'Z' },
                { text: "C. æ¡Œé¢æœ‰æ°´æ¼¬æˆ–å’–å•¡æ¼¬æ²’æ“¦ä¹¾", trait: 'H' }
            ]
        },
        {
            text: "å¦‚æœæ‰“æƒé‡åˆ°å›°å¢ƒ, æ‚¨æœƒæ€éº¼åš?",
            options: [
                { text: "A. ä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€ï¼Œå…ˆå¾é‚Šç·£é–‹å§‹æƒ/æ‹–", trait: 'S' },
                { text: "B. åœä¸‹ä¾†åˆ†é¡æ•´ç†å·¥å…·å’Œç‰©å“", trait: 'Z' },
                { text: "C. ç«‹å³æ‰¾å°‹å¹«æ‰‹æˆ–å”èª¿è³‡æº", trait: 'H' }
            ]
        },
    ];

    // --- åˆå§‹åŒ–å’Œ Firebase ---
    
    const $ = id => document.getElementById(id);
    let confirmationResolve = null; // ç”¨æ–¼å„²å­˜ Promise çš„ resolve å‡½æ•¸

    async function initializeFirebase() {
        if (Object.keys(firebaseConfig).length === 0) {
            showCustomAlert("ç³»çµ±éŒ¯èª¤", "éŒ¯èª¤ï¼šæœªæä¾› Firebase é…ç½®ã€‚");
            return;
        }
        
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, onAuthStateChanged, setLogLevel } = window.firebase;
        // setLogLevel('Debug'); // é–‹å•Ÿ Firebase Debug Log

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth); 
            }
            userId = auth.currentUser?.uid;

            // ç›£è½å§“åè¼¸å…¥æ¡†ï¼Œå•Ÿç”¨æŒ‰éˆ•
            $('name-input').addEventListener('input', checkStartEligibility);
            $('consent-checkbox').addEventListener('change', checkStartEligibility);
            
        } catch (error) {
            console.error("Firebase Auth Error:", error);
            showCustomAlert("é€£ç·šéŒ¯èª¤", "Firebase é€£ç·šå¤±æ•—ï¼š" + error.message);
        }
    }

    function checkStartEligibility() {
        const nameInput = $('name-input').value.trim();
        const consentChecked = $('consent-checkbox').checked;
        const isEligible = nameInput.length > 0 && consentChecked;

        $('startButton').disabled = !isEligible;
        $('clearMyDataButton').disabled = nameInput.length === 0;
    }

    // --- æ¸¬é©—æµç¨‹æ§åˆ¶ ---

    async function startQuiz() {
        userName = $('name-input').value.trim();
        if (!userName || !$('consent-checkbox').checked) {
            showCustomAlert("æç¤º", "è«‹è¼¸å…¥å§“åä¸¦å‹¾é¸åŒæ„æ¡†ï¼");
            return;
        }
        
        // æª¢æŸ¥æ˜¯å¦å·²æäº¤é
        if (await checkExistingSubmission(userName)) {
            showCustomAlert("æç¤º", `æ‚¨çš„å§“å [${userName}] å·²æäº¤éæ¸¬é©—çµæœã€‚è«‹æŸ¥çœ‹æ‚¨çš„çµæœæˆ–é¸æ“‡ã€Œæ¸…é™¤æˆ‘çš„æäº¤ç´€éŒ„ã€é‡æ–°é–‹å§‹ã€‚`);
            return;
        }

        // åˆå§‹åŒ–æ¸¬é©—ç‹€æ…‹
        currentQuizState.questions = shuffleArray(originalQuestions);
        currentQuizState.currentQuestionIndex = 0;
        currentQuizState.answers = {};
        currentQuizState.startTime = window.firebase.Timestamp.now();
        currentQuizState.isSubmitted = false;
        
        // åˆ‡æ›ç•«é¢
        $('start-screen').classList.add('hidden');
        $('result-screen').classList.add('hidden');
        $('quiz-screen').classList.remove('hidden');

        // é–‹å§‹è¨ˆæ™‚ä¸¦æ¸²æŸ“ç¬¬ä¸€é“é¡Œ
        startTimer();
        renderQuestion();
    }

    function renderQuestion() {
        const index = currentQuizState.currentQuestionIndex;
        const question = currentQuizState.questions[index];

        // æ›´æ–°é€²åº¦æ¨™ç±¤
        $('question-counter').textContent = `å•é¡Œ ${index + 1} / ${currentQuizState.questions.length}`;
        $('prevButton').disabled = index === 0;
        $('nextButton').classList.toggle('hidden', index === currentQuizState.questions.length - 1);
        $('submitButton').classList.toggle('hidden', index !== currentQuizState.questions.length - 1);
        
        $('question-text').textContent = question.text;

        const optionsContainer = $('options-container');
        optionsContainer.innerHTML = '';
        
        // éš¨æ©Ÿæ’åˆ—é¸é …ï¼Œå¢åŠ é¡Œç›®éˆæ´»æ€§
        const shuffledOptions = shuffleArray(question.options.map((opt, i) => ({ ...opt, key: String.fromCharCode(65 + i) })));
        
        shuffledOptions.forEach(option => {
            const isChecked = currentQuizState.answers[index] === option.key;
            
            const optionHtml = `
                <label class="block macaron-blue p-4 rounded-lg cursor-pointer hover:bg-pink-100 transition duration-150 border-2 border-transparent ${isChecked ? 'border-pink-500 bg-pink-100 shadow-md' : ''}">
                    <input type="radio" name="q${index}" value="${option.key}" data-trait="${option.trait}" 
                           class="mr-3 h-4 w-4 text-pink-600 border-gray-300 focus:ring-pink-500" ${isChecked ? 'checked' : ''}
                           onclick="recordAnswer(${index}, '${option.key}')">
                    <span class="font-medium text-gray-800">${option.key}. ${option.text}</span>
                </label>
            `;
            optionsContainer.innerHTML += optionHtml;
        });
        
        // æª¢æŸ¥ä¸‹ä¸€é¡ŒæŒ‰éˆ•ç‹€æ…‹
        $('nextButton').disabled = !currentQuizState.answers.hasOwnProperty(index);
    }

    function recordAnswer(index, key) {
        currentQuizState.answers[index] = key;
        
        // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºé¸ä¸­ç‹€æ…‹ï¼Œä¸¦æª¢æŸ¥ä¸‹ä¸€é¡ŒæŒ‰éˆ•
        renderQuestion(); 
    }

    function prevQuestion() {
        if (currentQuizState.currentQuestionIndex > 0) {
            currentQuizState.currentQuestionIndex--;
            renderQuestion();
        }
    }

    function nextQuestion() {
        if (!currentQuizState.answers.hasOwnProperty(currentQuizState.currentQuestionIndex)) {
            showCustomAlert("æç¤º", "è«‹é¸æ“‡ä¸€å€‹ç­”æ¡ˆå¾Œå†é€²å…¥ä¸‹ä¸€é¡Œï¼");
            return;
        }

        if (currentQuizState.currentQuestionIndex < currentQuizState.questions.length - 1) {
            currentQuizState.currentQuestionIndex++;
            renderQuestion();
        }
    }

    function startTimer() {
        clearInterval(currentQuizState.timerInterval);
        
        let timeLeft = currentQuizState.timeLimitSeconds;

        const updateTimerDisplay = () => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            $('timer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 60) {
                $('timer').classList.add('text-red-600');
            } else {
                $('timer').classList.remove('text-red-600');
            }

            if (timeLeft <= 0) {
                clearInterval(currentQuizState.timerInterval);
                if (!currentQuizState.isSubmitted) {
                    submitQuiz(true); // æ™‚é–“åˆ°è‡ªå‹•æäº¤
                }
            }
            timeLeft--;
        };

        updateTimerDisplay(); // ç«‹å³é¡¯ç¤º
        currentQuizState.timerInterval = setInterval(updateTimerDisplay, 1000);
    }
    
    // --- æäº¤èˆ‡çµæœè™•ç† ---

    async function submitQuiz(isTimedOut = false) {
        if (currentQuizState.isSubmitted) return;
        
        // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰å•é¡Œéƒ½å·²ä½œç­”
        for (let i = 0; i < currentQuizState.questions.length; i++) {
            if (!currentQuizState.answers.hasOwnProperty(i)) {
                if (isTimedOut) break; // å¦‚æœæ˜¯æ™‚é–“åˆ°ï¼Œæœªä½œç­”çš„ç›´æ¥å¿½ç•¥
                showCustomAlert("æç¤º", `å•é¡Œ ${i + 1} å°šæœªä½œç­”ï¼Œè«‹å®Œæˆæ‰€æœ‰é¡Œç›®ï¼`);
                return;
            }
        }

        if (!await showCustomConfirm("æäº¤ç¢ºèª", isTimedOut ? "æ™‚é–“å·²åˆ°ï¼å°‡è‡ªå‹•æäº¤ç›®å‰ä½œç­”çµæœã€‚" : "æ‚¨ç¢ºå®šè¦æäº¤æ¸¬é©—å—ï¼Ÿæäº¤å¾Œç„¡æ³•æ›´æ”¹ã€‚")) {
            return; // ä½¿ç”¨è€…é¸æ“‡å–æ¶ˆ
        }

        currentQuizState.isSubmitted = true;
        clearInterval(currentQuizState.timerInterval);
        
        // é–å®šæäº¤æŒ‰éˆ•
        $('submitButton').disabled = true;

        // 1. è¨ˆç®—åˆ†æ•¸å’Œä¸»è¦å‚¾å‘
        const scores = { S: 0, Z: 0, H: 0 };
        const questions = currentQuizState.questions;
        
        for (let i = 0; i < questions.length; i++) {
            const selectedKey = currentQuizState.answers[i];
            if (selectedKey) {
                const selectedOption = questions[i].options.find(opt => String.fromCharCode(65 + questions[i].options.indexOf(opt)) === selectedKey);
                if (selectedOption) {
                     // æ‰¾åˆ°é¸é …åœ¨åŸé™£åˆ—ä¸­çš„ç´¢å¼•ï¼Œä¸¦é‡æ–°è¨ˆç®—å…¶ç‰¹å¾µ
                    const originalIndex = questions[i].options.findIndex(opt => String.fromCharCode(65 + questions[i].options.indexOf(opt)) === selectedKey);
                    // ä½¿ç”¨åŸé¡Œç›®å®šç¾©ä¾†ç¢ºä¿ç‰¹å¾µè¨ˆç®—æ­£ç¢º
                    const trait = originalQuestions[originalQuestions.findIndex(q => q.text === questions[i].text)].options[originalIndex].trait;
                    scores[trait]++;
                }
            }
        }
        
        let primaryTrait = '';
        let maxScore = -1;
        
        for (const [trait, score] of Object.entries(scores)) {
            if (score > maxScore) {
                maxScore = score;
                primaryTrait = trait;
            } else if (score === maxScore) {
                // å¹³æ‰‹æ™‚ï¼Œä¿ç•™åŸä¾†çš„ï¼Œæˆ–ä¸æŒ‡å®šï¼ˆé€™è£¡é¸æ“‡ä¿ç•™ï¼Œå› ç‚ºé¡Œç›®æ•¸ä¸å¤šï¼‰
            }
        }

        // 2. æº–å‚™æäº¤è³‡æ–™
        const submissionData = {
            name: userName,
            scores: scores,
            primaryTrait: primaryTrait,
            timestamp: window.firebase.Timestamp.now(),
            totalTimeSeconds: currentQuizState.timeLimitSeconds - (isTimedOut ? 0 : parseInt($('timer').textContent.split(':')[0]) * 60 + parseInt($('timer').textContent.split(':')[1])),
            answers: currentQuizState.answers // å„²å­˜åŸå§‹ç­”æ¡ˆä¾›ä¸»æŒäººæŸ¥é–±
        };

        // 3. å„²å­˜åˆ° Firestore
        try {
            const { doc, setDoc } = window.firebase;
            // ä½¿ç”¨å§“åä½œç‚ºæ–‡ä»¶ IDï¼Œç¢ºä¿æ¯äººåªæœ‰ä¸€ä»½æäº¤
            const submissionRef = doc(db, SUBMISSION_COLLECTION_PATH, userName); 
            await setDoc(submissionRef, submissionData);

            // 4. åˆ‡æ›åˆ°çµæœé é¢
            $('quiz-screen').classList.add('hidden');
            renderResultScreen(submissionData);

        } catch (e) {
            console.error("Submission Error:", e);
            showCustomAlert("æäº¤å¤±æ•—", `è³‡æ–™åº«å„²å­˜éŒ¯èª¤: ${e.message}`);
            $('submitButton').disabled = false; // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
            currentQuizState.isSubmitted = false;
        }
    }

    function renderResultScreen(submissionData) {
        $('result-screen').classList.remove('hidden');
        
        const { scores, primaryTrait } = submissionData;
        
        // é¡¯ç¤ºå€‹äººå‚¾å‘
        $('trait-scores').innerHTML = `
            S (æƒæ‹–): <span class="font-extrabold text-green-700">${scores.S}</span> åˆ†, 
            Z (æ•´ç†): <span class="font-extrabold text-yellow-700">${scores.Z}</span> åˆ†, 
            H (æ´»å‹•): <span class="font-extrabold text-pink-700">${scores.H}</span> åˆ†ã€‚<br>
            <span class="mt-1 inline-flex text-sm leading-5 font-semibold rounded-full border trait-${primaryTrait}">
                æ‚¨çš„ä¸»è¦å‚¾å‘ç‚ºï¼š${primaryTrait === 'S' ? 'S (æƒæ‹–)' : primaryTrait === 'Z' ? 'Z (æ•´ç†)' : 'H (æ´»å‹•)'}
            </span>
        `;
        
        // é–‹å§‹ç›£è½æœ€çµ‚åˆ†çµ„çµæœ
        listenToFinalAssignment();
        // ç«‹å³æª¢æŸ¥ä¸€æ¬¡åˆ†çµ„çµæœ
        checkAssignment(true); 
    }
    
    function listenToFinalAssignment() {
        if (!db) return;
        const { doc, onSnapshot } = window.firebase;

        const assignmentRef = doc(db, FINAL_ASSIGNMENT_DOC_PATH);
        // å¯¦æ™‚ç›£è½æœ€çµ‚åˆ†çµ„
        onSnapshot(assignmentRef, (docSnap) => {
            if (docSnap.exists() && docSnap.data().teams) {
                displayFinalAssignment(docSnap.data().teams);
            } else {
                $('final-assignment-display').classList.add('hidden');
                $('result-status').textContent = 'âœ… æäº¤æˆåŠŸï¼æ­£åœ¨ç­‰å¾…æœ€çµ‚åˆ†çµ„çµæœ...';
            }
        }, (error) => {
            console.error("Error listening to final assignment:", error);
        });
    }

    async function checkAssignment(isInitialCheck = false) {
        if (!db) {
            showCustomAlert("éŒ¯èª¤", "Firebase æœªé€£ç·šã€‚");
            return;
        }
        
        $('checkAssignmentButton').disabled = true;
        $('checkAssignmentButton').textContent = 'æª¢æŸ¥ä¸­...';

        try {
            const { doc, getDoc } = window.firebase;
            const assignmentRef = doc(db, FINAL_ASSIGNMENT_DOC_PATH);
            const docSnap = await getDoc(assignmentRef);
            
            if (docSnap.exists() && docSnap.data().teams) {
                const teams = docSnap.data().teams;
                displayFinalAssignment(teams);
            } else if (!isInitialCheck) {
                showCustomAlert("æç¤º", "ä¸»æŒäººå°šæœªç™¼å¸ƒæœ€çµ‚åˆ†çµ„çµæœï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }

        } catch (e) {
            console.error("Check Assignment Error:", e);
            if (!isInitialCheck) showCustomAlert("æŸ¥è©¢å¤±æ•—", "æŸ¥è©¢åˆ†çµ„çµæœå¤±æ•—: " + e.message);
        } finally {
            $('checkAssignmentButton').textContent = 'ğŸ”„ æª¢æŸ¥åˆ†çµ„çµæœ';
            $('checkAssignmentButton').disabled = false;
        }
    }

    function displayFinalAssignment(teams) {
        let assignedTask = null;
        let teamMembers = [];
        
        // å°‹æ‰¾æˆ‘çš„ä»»å‹™
        for (const [taskName, members] of Object.entries(teams)) {
            if (members.includes(userName)) {
                assignedTask = taskName;
                teamMembers = members.filter(m => m !== userName); // ç§»é™¤è‡ªå·±
                break;
            }
        }
        
        const displayDiv = $('final-assignment-display');
        
        if (assignedTask) {
            $('result-status').textContent = 'ğŸ‰ æœ€çµ‚åˆ†çµ„çµæœå·²ç™¼å¸ƒï¼';
            displayDiv.classList.remove('hidden');
            
            // æ‰¾å‡ºä»»å‹™çš„ç´°ç¯€ (ç‚ºäº†å‘ˆç¾è©³ç´°è³‡è¨Š)
            const allTasks = [
                { taskName: 'ç±¤ä¸€ï¼šå…¬å€å‰ (æƒæ‹–çµ„)', detail: '6.0 WUï¼Œè² è²¬å…¬å€å‰åœ°é¢æƒæ‹–åŠç«‹é¢æ•´æ½”ã€‚' },
                { taskName: 'ç±¤äºŒï¼šå…¬å€å¾Œ (æƒæ‹–çµ„)', detail: '6.0 WUï¼Œè² è²¬å…¬å€å¾Œåœ°é¢æƒæ‹–åŠç«‹é¢æ•´æ½”ã€‚' },
                { taskName: 'ç±¤ä¸‰ï¼šå¤šå€åŸŸæƒæ‹–çµ„', detail: '5.7 WUï¼Œè² è²¬å€‰åº«ã€å¤§å°æœƒè­°å®¤åœ°é¢æƒæ‹–ã€‚' },
                { taskName: 'ç±¤å››ï¼šå…§éƒ¨èˆ‡è¤‡é›œæ•´ç†çµ„', detail: '5.0 WUï¼Œè² è²¬å†°ç®±/æ«¥æ«ƒå…§éƒ¨æ¸…æ½”èˆ‡å€‰åº«é›œç‰©æ•´ç†ã€‚' },
                { taskName: 'ç±¤äº”ï¼šæ´»å‹•èˆ‡æ“¦æ‹­æ”¶å°¾çµ„', detail: '4.7 WUï¼Œè² è²¬æ´»å‹•æº–å‚™(æ¹¯åœ“/è›‹ç³•)åŠæ‰€æœ‰æª¯é¢æ“¦æ‹­èˆ‡æœ€çµ‚æ”¶å°¾ã€‚' },
            ];
            const taskDetail = allTasks.find(t => t.taskName === assignedTask)?.detail || 'ç„¡è©³ç´°èªªæ˜';

            $('my-task-detail').innerHTML = `æ‚¨è¢«åˆ†é…åˆ°ï¼š<span class="text-green-900">${assignedTask}</span><br><span class="text-base font-normal text-green-600">${taskDetail}</span>`;
            $('team-members').textContent = `æ‚¨çš„éšŠå‹æ˜¯ï¼š${teamMembers.length > 0 ? teamMembers.join('ã€') : 'ç„¡å…¶ä»–éšŠå‹'}`;
        } else {
             // æäº¤æˆåŠŸä½†æœªè¢«åˆ†é…ï¼ˆä¸»æŒäººå¯èƒ½å°šæœªå®Œæˆæ‰€æœ‰åˆ†çµ„ï¼‰
            $('result-status').textContent = 'âœ… æäº¤æˆåŠŸï¼æ­£åœ¨ç­‰å¾…æœ€çµ‚åˆ†çµ„çµæœ...';
            displayDiv.classList.add('hidden');
        }
    }

    // --- å·¥å…·åŠŸèƒ½ï¼šæª¢æŸ¥èˆ‡æ¸…é™¤æäº¤ ---

    async function checkExistingSubmission(name) {
        if (!db || !name) return false;
        const { doc, getDoc } = window.firebase;
        const submissionRef = doc(db, SUBMISSION_COLLECTION_PATH, name);
        try {
            const docSnap = await getDoc(submissionRef);
            if (docSnap.exists()) {
                // å¦‚æœå·²å­˜åœ¨ï¼Œç›´æ¥é¡¯ç¤ºçµæœé é¢
                renderResultScreen(docSnap.data());
                return true;
            }
            return false;
        } catch (e) {
            console.error("Error checking submission:", e);
            return false;
        }
    }

    function confirmClearMyData() {
        userName = $('name-input').value.trim();
        if (!userName) return;

        showCustomConfirm("åˆªé™¤ç¢ºèª", `æ‚¨ç¢ºå®šè¦æ¸…é™¤èˆ‡å§“å [${userName}] ç›¸é—œçš„æ‰€æœ‰æäº¤ç´€éŒ„å—ï¼Ÿ (æ­¤æ“ä½œç„¡æ³•å¾©åŸ)`).then(isConfirmed => {
            if (isConfirmed) {
                clearMyData(userName);
            }
        });
    }

    async function clearMyData(name) {
        if (!db || !name) return;
        $('clearMyDataButton').disabled = true;
        
        try {
            const { doc, deleteDoc } = window.firebase;
            const submissionRef = doc(db, SUBMISSION_COLLECTION_PATH, name);
            await deleteDoc(submissionRef);

            // æ¸…é™¤å¾Œé‡ç½®é é¢
            $('name-input').value = '';
            $('consent-checkbox').checked = false;
            $('start-screen').classList.remove('hidden');
            $('result-screen').classList.add('hidden');
            $('quiz-screen').classList.add('hidden');
            checkStartEligibility();

            showCustomAlert("æˆåŠŸ", `å§“å [${name}] çš„æäº¤ç´€éŒ„å·²æˆåŠŸæ¸…é™¤ï¼Œæ‚¨å¯ä»¥é‡æ–°é–‹å§‹æ¸¬é©—ã€‚`, "text-green-600");

        } catch (e) {
            console.error("Clear Data Error:", e);
            showCustomAlert("åˆªé™¤å¤±æ•—", `æ¸…é™¤ç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤: ${e.message}`);
        } finally {
            $('clearMyDataButton').disabled = false;
        }
    }

    // --- å…±ç”¨å·¥å…·å‡½å¼ ---

    // é™£åˆ—æ´—ç‰Œå‡½å¼ (Fisher-Yates æ¼”ç®—æ³•)
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // Custom Alert å‡½å¼ (å–ä»£ window.alert)
    window.showCustomAlert = function(title, message, titleColor = "text-red-600") {
        const modal = $('custom-alert-modal');
        if (!modal) return;
        
        $('alert-title').textContent = title;
        $('alert-title').className = `text-xl font-bold mb-4 ${titleColor}`;
        $('alert-message').textContent = message;
        
        // è§¸ç™¼é¡¯ç¤ºå‹•ç•«
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.querySelector('div').classList.add('scale-100');
            modal.querySelector('div').classList.remove('scale-90');
        }, 10);
    }

    window.closeCustomAlert = function() {
        const modal = $('custom-alert-modal');
        if (modal) {
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-90');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
    }

    // Custom Confirm å‡½å¼ (å–ä»£ window.confirm)
    function showCustomConfirm(title, message) {
        const modal = $('custom-confirm-modal');
        if (!modal) return Promise.resolve(false); // å®‰å…¨å›é€€
        
        $('confirm-message').textContent = message;
        
        return new Promise(resolve => {
            confirmationResolve = resolve;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('div').classList.add('scale-100');
                modal.querySelector('div').classList.remove('scale-90');
            }, 10);
        });
    }

    window.handleConfirmation = function(result) {
        const modal = $('custom-confirm-modal');
        if (modal) {
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-90');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        if (confirmationResolve) {
            confirmationResolve(result);
            confirmationResolve = null;
        }
    }


    document.addEventListener('DOMContentLoaded', initializeFirebase);
</script>
</body>
</html>